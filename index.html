
<html lang="fr">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="theme-color" content="#343a40">
        <link rel="manifest" href="manifest.json">
        <link rel="stylesheet" href="css/leaflet.css">
        <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
        <link rel="stylesheet" href="css/L.Control.Locate.min.css">
        <link rel="stylesheet" href="css/qgis2web.css">
        <link rel="stylesheet" href="css/fontawesome-all.min.css">
        <link rel="stylesheet" href="css/MarkerCluster.css">
        <link rel="stylesheet" href="css/MarkerCluster.Default.css">
        <link rel="stylesheet" href="css/leaflet.photon.css">
        <link rel="stylesheet" href="css/leaflet-measure.css">
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
        <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        #navbar {
            height: 60px;
            background-color: #343a40;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 1000;
            position: relative;
            flex-wrap: nowrap;
        }
        #navbar nav {
            display: flex;
            align-items: center;
            flex: 1;
            justify-content: space-around;
        }
        #navbar-tools {
            display: none;
        }
        #navbar .nav-link {
            color: white !important;
            margin: 0 5px;
            cursor: pointer;
            font-size: 12px;
        }
        #navbar .nav-link:hover {
            color: #ffc107 !important;
        }
        #map {
            height: calc(100vh - 60px);
            width: 100%;
        }
        .control-panel {
            background: white;
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 5px;
        }
        .control-toggle {
            cursor: pointer;
            background: #f8f9fa;
            border: 1px solid #ccc;
            padding: 5px;
            margin-bottom: 10px;
            text-align: center;
        }
        #side-panels {
            position: absolute;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 1000;
        }
        .side-panel {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 300px;
            background: white;
            border: 1px solid #ccc;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            pointer-events: all;
            overflow-y: auto;
            transition: transform 0.3s ease;
        }
        .left-panel {
            left: -300px;
        }
        .right-panel {
            right: -300px;
        }
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-bottom: 1px solid #ccc;
        }
        .panel-header button {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }
        .toggle-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: #007bff;
            color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
            z-index: 1001;
            border-radius: 0 5px 5px 0;
            font-size: 14px;
        }
        .left-toggle {
            left: 0;
        }
        .right-toggle {
            right: 0;
            border-radius: 5px 0 0 5px;
        }
        .side-panel.open {
            transform: translateX(300px);
        }
        .right-panel.open {
            transform: translateX(-300px);
        }

        @media (max-width: 768px) {
            #navbar {
                flex-wrap: wrap;
                padding: 10px 5px;
                height: auto;
            }
            #navbar nav {
                order: 1;
                width: 100%;
                justify-content: center;
                margin-top: 10px;
                flex-wrap: wrap;
            }
            #navbar .navbar-brand {
                width: 100%;
                text-align: center;
                margin-bottom: 10px;
            }
            #navbar .nav-link {
                font-size: 12px;
                margin: 5px;
            }
            #search {
                display: none; /* Hide search bar in nav for more space */
            }
            .toggle-btn {
                font-size: 12px;
                padding: 8px;
            }
            #map {
                height: 100vh; /* Make map full height */
            }
            #navbar {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                z-index: 1001; /* Ensure navbar is on top of the map */
            }
        }
        
        </style>
        <title>CARTO WEB LIMITES ADMINISTRATIVES DU SÉNÉGAL</title>
    </head>
    <body>
        <div id="welcome-panel" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 1px solid #ccc; z-index: 2001; max-height: 80vh; overflow-y: auto; width: 80%; max-width: 500px; text-align: center;">
            <h4>Bienvenue sur la carte interactive des divisions administratives du Sénégal</h4>
            <p>Découvrez l’organisation administrative du territoire sénégalais à travers une cartographie claire et interactive.</p>
            <p>Cette application est destinée à l’apprentissage, à la recherche et à l’aide à la décision.</p>
            <button onclick="document.getElementById('welcome-panel').style.display='none';" style="margin-top: 10px;">Commencer</button>
        </div>
        <div id="navbar">
            <span class="navbar-brand">SIG Sénégal</span>
            <nav>
                <a class="nav-link" id="home">Accueil</a>
                <a class="nav-link" id="catalog">Catalogue des données</a>
                <div class="dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="queryDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Requête
                    </a>
                    <div class="dropdown-menu" aria-labelledby="queryDropdown">
                        <a class="dropdown-item" href="#" id="spatial-query">Requête spatiale</a>
                        <a class="dropdown-item" href="#" id="attribute-query">Requête attributaire</a>
                    </div>
                </div>
                <div class="dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="downloadDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Télécharger
                    </a>
                    <div class="dropdown-menu" aria-labelledby="downloadDropdown">
                        <a class="dropdown-item" href="#" id="download-csv">Télécharger CSV</a>
                        <a class="dropdown-item" href="#" id="download-geojson">Télécharger GeoJSON</a>
                    </div>
                </div>

                <a class="nav-link" id="print">Impression</a>
                <a class="nav-link" id="about">À propos</a>
                <a class="nav-link" id="install-app" style="display: none; cursor: pointer;">Installer</a>
                <input type="text" id="search" placeholder="Recherche rapide" style="margin-left: 10px; padding: 2px 5px; font-size: 12px; width: 150px;">
                <a class="nav-link" id="locate-me" title="Me localiser"><i class="fas fa-map-marker-alt"></i></a>
            </nav>
            <div id="navbar-tools">
                <a class="nav-link" id="measure">Mesure</a>
                <a class="nav-link" id="zoom-in">Zoom +</a>
                <a class="nav-link" id="zoom-out">Zoom -</a>
            </div>
        </div>
        <div id="side-panels">
            <div id="layers-panel" class="side-panel left-panel">
                <div class="panel-header">
                    <h4>Couches</h4>
                    <button id="close-layers">&times;</button>
                </div>
                <div id="layers-list">
                    <div><input type="checkbox" id="layer-region" checked> <label for="layer-region">Régions</label></div>
                    <div><input type="checkbox" id="layer-dept" checked> <label for="layer-dept">Départements</label></div>
                    <div><input type="checkbox" id="layer-arr" checked> <label for="layer-arr">Arrondissements</label></div>
                    <div><input type="checkbox" id="layer-routes" checked> <label for="layer-routes">Routes</label></div>
                    <div><input type="checkbox" id="layer-localites" checked> <label for="layer-localites">Localités</label></div>
                </div>
            </div>
            <div id="queries-panel" class="side-panel right-panel">
                <div class="panel-header">
                    <h4>Contrôle</h4>
                    <button id="close-queries">&times;</button>
                </div>
                <div id="basemaps-list">
                    <h5>Fonds de carte</h5>
                    <div><input type="radio" name="basemap" id="osm" checked> <label for="osm">OpenStreetMap</label></div>
                    <div><input type="radio" name="basemap" id="satellite"> <label for="satellite">Google Satellite</label></div>
                </div>
                <div id="legend-list">
                    <h5>Légende</h5>
                    <div><span style="background-color:#8dd3c7;">&nbsp;&nbsp;&nbsp;</span> Régions</div>
                    <div><span style="background-color:#ffffb3;">&nbsp;&nbsp;&nbsp;</span> Départements</div>
                    <div><span style="background-color:#bebada;">&nbsp;&nbsp;&nbsp;</span> Arrondissements</div>
                    <div><span style="background-color:#fb8072;">&nbsp;&nbsp;&nbsp;</span> Routes</div>
                    <div><span style="background-color:#80b1d3;">&nbsp;&nbsp;&nbsp;</span> Localités</div>
                </div>

            </div>

            </div>
        </div>
        <div id="map">
        </div>
        <button id="toggle-layers" class="toggle-btn left-toggle">☰ Couches</button>
        <button id="toggle-queries" class="toggle-btn right-toggle">☰ Contrôle</button>
        <script src="js/qgis2web_expressions.js"></script>
        <script src="js/leaflet.js"></script>
        <script src="js/L.Control.Layers.Tree.min.js"></script>
        <script src="js/L.Control.Locate.min.js"></script>
        <script src="js/leaflet.rotatedMarker.js"></script>
        <script src="js/leaflet-hash.js"></script>
        <script src="js/Autolinker.min.js"></script>
        <script src="js/rbush.min.js"></script>
        <script src="js/labelgun.min.js"></script>
        <script src="js/labels.js"></script>
        <script src="js/leaflet.photon.js"></script>
        <script src="js/leaflet-measure.js"></script>
        <script src="js/leaflet.markercluster.js"></script>
        <script src="data/Region_1.js"></script>
        <script src="data/Departement_2.js"></script>
        <script src="data/Arrondissement_3.js"></script>
        <script src="data/Routes_4.js"></script>
        <script src="data/localites_5.js"></script>
        <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>
        <script>
        // Define UTM Zone 28N
        proj4.defs("EPSG:32628", "+proj=utm +zone=28 +datum=WGS84 +units=m +no_defs");
        </script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/leaflet-minimap@3.6.1/dist/Control.MiniMap.min.js"></script>
        <script>
        var highlightLayer;
        function highlightFeature(e) {
            highlightLayer = e.target;

            if (e.target.feature.geometry.type === 'LineString' || e.target.feature.geometry.type === 'MultiLineString') {
              highlightLayer.setStyle({
                color: '#ffff00',
              });
            } else {
              highlightLayer.setStyle({
                fillColor: '#ffff00',
                fillOpacity: 1
              });
            }
            highlightLayer.openPopup();
        }
        var map = L.map('map', {
            zoomControl:false, maxZoom:25, minZoom:1
        }).setView([14.7, -14.7], 7);
        var hash = new L.Hash(map);
        map.attributionControl.setPrefix('<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; <a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> &middot; <a href="https://qgis.org">QGIS</a>');
        var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});
        // remove popup's row if "visible-with-data"
        function removeEmptyRowsFromPopupContent(content, feature) {
         var tempDiv = document.createElement('div');
         tempDiv.innerHTML = content;
         var rows = tempDiv.querySelectorAll('tr');
         for (var i = 0; i < rows.length; i++) {
             var td = rows[i].querySelector('td.visible-with-data');
             var key = td ? td.id : '';
             if (td && td.classList.contains('visible-with-data') && feature.properties[key] == null) {
                 rows[i].parentNode.removeChild(rows[i]);
             }
         }
         return tempDiv.innerHTML;
        }
        // modify popup if contains media
        function addClassToPopupIfMedia(content, popup) {
            var tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            var imgTd = tempDiv.querySelector('td img');
            if (imgTd) {
                var src = imgTd.getAttribute('src');
                if (/\.(jpg|jpeg|png|gif|bmp|webp|avif)$/i.test(src)) {
                    popup._contentNode.classList.add('media');
                    setTimeout(function() {
                        popup.update();
                    }, 10);
                } else if (/\.(mp3|wav|ogg|aac)$/i.test(src)) {
                    var audio = document.createElement('audio');
                    audio.controls = true;
                    audio.src = src;
                    imgTd.parentNode.replaceChild(audio, imgTd);
                    popup._contentNode.classList.add('media');
                    setTimeout(function() {
                        popup.setContent(tempDiv.innerHTML);
                        popup.update();
                    }, 10);
                } else if (/\.(mp4|webm|ogg|mov)$/i.test(src)) {
                    var video = document.createElement('video');
                    video.controls = true;
                    video.src = src;
                    video.style.width = "400px";
                    video.style.height = "300px";
                    video.style.maxHeight = "60vh";
                    video.style.maxWidth = "60vw";
                    imgTd.parentNode.replaceChild(video, imgTd);
                    popup._contentNode.classList.add('media');
                    // Aggiorna il popup quando il video carica i metadati
                    video.addEventListener('loadedmetadata', function() {
                        popup.update();
                    });
                    setTimeout(function() {
                        popup.setContent(tempDiv.innerHTML);
                        popup.update();
                    }, 10);
                } else {
                    popup._contentNode.classList.remove('media');
                }
            } else {
                popup._contentNode.classList.remove('media');
            }
        }
        var zoomControl = L.control.zoom({
            position: 'topright'
        }).addTo(map);
        
        // Geolocation button in navbar
        var locateControl = L.control.locate({
            position: 'topleft',
            strings: {
                title: "Me localiser"
            }
        }).addTo(map);

         var measureControl = new L.Control.Measure({
            position: 'topright',
            primaryLengthUnit: 'meters',
            secondaryLengthUnit: 'kilometers',
            primaryAreaUnit: 'sqmeters',
            secondaryAreaUnit: 'hectares'
        });
        measureControl.addTo(map);
        document.getElementsByClassName('leaflet-control-measure-toggle')[0].innerHTML = '';
        document.getElementsByClassName('leaflet-control-measure-toggle')[0].className += ' fas fa-ruler';
        L.control.scale({position: 'bottomright'}).addTo(map);
        var miniMap = new L.Control.MiniMap(L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }), { toggleDisplay: true, position: 'bottomright' });
        var coordControl = L.control({position: 'bottomleft'});
        coordControl.onAdd = function(map) {
            var div = L.DomUtil.create('div', 'leaflet-control-coordinates');
            div.innerHTML = 'Coordonnées UTM: --';
            map.on('mousemove', function(e) {
                var utm = proj4('EPSG:4326', 'EPSG:32628', [e.latlng.lng, e.latlng.lat]);
                div.innerHTML = 'UTM 28N: ' + utm[0].toFixed(0) + ', ' + utm[1].toFixed(0);
            });
            return div;
        };
        coordControl.addTo(map);
        var bounds_group = new L.featureGroup([]);
        function setBounds() {
            if (bounds_group.getLayers().length) {
                map.fitBounds(bounds_group.getBounds());
            }
        }
        var layer_OSM = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        });
        map.createPane('pane_GoogleSatellite_0');
        map.getPane('pane_GoogleSatellite_0').style.zIndex = 400;
        var layer_GoogleSatellite_0 = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
            pane: 'pane_GoogleSatellite_0',
            opacity: 1.0,
            attribution: '<a href="https://www.google.at/permissions/geoguidelines/attr-guide.html">Map data ©2015 Google</a>',
            minZoom: 1,
            maxZoom: 25,
            minNativeZoom: 0,
            maxNativeZoom: 20
        });
        layer_OSM;
        map.addLayer(layer_OSM);
        function pop_Region_1(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                    if (typeof layer.closePopup == 'function') {
                        layer.closePopup();
                    } else {
                        layer.eachLayer(function(feature){
                            feature.closePopup()
                        });
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table>\
                    <tr>\
                        <td colspan="2"><strong>Code</strong><br />' + (feature.properties['Code'] !== null ? autolinker.link(String(feature.properties['Code']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2"><strong>Région</strong><br />' + (feature.properties['Région'] !== null ? autolinker.link(String(feature.properties['Région']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_Region_1_0(feature) {
            switch(String(feature.properties['Région'])) {
                case 'DAKAR':
                    return {
                pane: 'pane_Region_1',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(91,42,217,1.0)',
                interactive: true,
            }
                    break;
                case 'DIOURBEL':
                    return {
                pane: 'pane_Region_1',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(54,70,215,1.0)',
                interactive: true,
            }
                    break;
                case 'FATICK':
                    return {
                pane: 'pane_Region_1',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(150,28,81,1.0)',
                interactive: true,
            }
                    break;
                case 'KAFFRINE':
                    return {
                pane: 'pane_Region_1',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(95,107,163,1.0)',
                interactive: true,
            }
                    break;
                case 'KAOLACK':
                    return {
                pane: 'pane_Region_1',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(76,103,192,1.0)',
                interactive: true,
            }
                    break;
                case 'KEDOUGOU':
                    return {
                pane: 'pane_Region_1',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(223,237,72,1.0)',
                interactive: true,
            }
                    break;
                case 'KOLDA':
                    return {
                pane: 'pane_Region_1',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(224,199,97,1.0)',
                interactive: true,
            }
                    break;
                case 'LOUGA':
                    return {
                pane: 'pane_Region_1',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(71,124,202,1.0)',
                interactive: true,
            }
                    break;
                case 'MATAM':
                    return {
                pane: 'pane_Region_1',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(138,76,126,1.0)',
                interactive: true,
            }
                    break;
                case 'SAINT-LOUIS':
                    return {
                pane: 'pane_Region_1',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(127,164,35,1.0)',
                interactive: true,
            }
                    break;
                case 'SEDHIOU':
                    return {
                pane: 'pane_Region_1',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(117,227,210,1.0)',
                interactive: true,
            }
                    break;
                case 'TAMBACOUNDA':
                    return {
                pane: 'pane_Region_1',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(155,53,227,1.0)',
                interactive: true,
            }
                    break;
                case 'THIES':
                    return {
                pane: 'pane_Region_1',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(150,252,150,1.0)',
                interactive: true,
            }
                    break;
                case 'ZIGUINCHOR':
                    return {
                pane: 'pane_Region_1',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(160,83,136,1.0)',
                interactive: true,
            }
                    break;
            }
        }
        map.createPane('pane_Region_1');
        map.getPane('pane_Region_1').style.zIndex = 401;
        map.getPane('pane_Region_1').style['mix-blend-mode'] = 'normal';
        var layer_Region_1 = new L.geoJson(json_Region_1, {
            attribution: '',
            interactive: true,
            dataVar: 'json_Region_1',
            layerName: 'layer_Region_1',
            pane: 'pane_Region_1',
            onEachFeature: pop_Region_1,
            style: style_Region_1_0,
        });
        bounds_group.addLayer(layer_Region_1);
        map.addLayer(layer_Region_1);
        function pop_Departement_2(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                    if (typeof layer.closePopup == 'function') {
                        layer.closePopup();
                    } else {
                        layer.eachLayer(function(feature){
                            feature.closePopup()
                        });
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table>\
                    <tr>\
                        <td colspan="2"><strong>Région</strong><br />' + (feature.properties['Région'] !== null ? autolinker.link(String(feature.properties['Région']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2"><strong>Dept</strong><br />' + (feature.properties['Dept'] !== null ? autolinker.link(String(feature.properties['Dept']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2"><strong>Cod_Dept</strong><br />' + (feature.properties['Cod_Dept'] !== null ? autolinker.link(String(feature.properties['Cod_Dept']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_Departement_2_0() {
            return {
                pane: 'pane_Departement_2',
                opacity: 1,
                color: 'rgba(227,26,28,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 4.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(152,229,113,0.0)',
                interactive: true,
            }
        }
        map.createPane('pane_Departement_2');
        map.getPane('pane_Departement_2').style.zIndex = 402;
        map.getPane('pane_Departement_2').style['mix-blend-mode'] = 'normal';
        var layer_Departement_2 = new L.geoJson(json_Departement_2, {
            attribution: '',
            interactive: true,
            dataVar: 'json_Departement_2',
            layerName: 'layer_Departement_2',
            pane: 'pane_Departement_2',
            onEachFeature: pop_Departement_2,
            style: style_Departement_2_0,
        });
        bounds_group.addLayer(layer_Departement_2);
        map.addLayer(layer_Departement_2);
        function pop_Arrondissement_3(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                    if (typeof layer.closePopup == 'function') {
                        layer.closePopup();
                    } else {
                        layer.eachLayer(function(feature){
                            feature.closePopup()
                        });
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table>\
                    <tr>\
                        <td colspan="2"><strong>OBJECTID</strong><br />' + (feature.properties['OBJECTID'] !== null ? autolinker.link(String(feature.properties['OBJECTID']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2"><strong>dept</strong><br />' + (feature.properties['dept'] !== null ? autolinker.link(String(feature.properties['dept']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2"><strong>cod_dept</strong><br />' + (feature.properties['cod_dept'] !== null ? autolinker.link(String(feature.properties['cod_dept']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2"><strong>ccod_dept</strong><br />' + (feature.properties['ccod_dept'] !== null ? autolinker.link(String(feature.properties['ccod_dept']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2"><strong>cav</strong><br />' + (feature.properties['cav'] !== null ? autolinker.link(String(feature.properties['cav']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2"><strong>cod_cav</strong><br />' + (feature.properties['cod_cav'] !== null ? autolinker.link(String(feature.properties['cod_cav']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2"><strong>ccod_cav</strong><br />' + (feature.properties['ccod_cav'] !== null ? autolinker.link(String(feature.properties['ccod_cav']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2"><strong>arr</strong><br />' + (feature.properties['arr'] !== null ? autolinker.link(String(feature.properties['arr']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_Arrondissement_3_0() {
            return {
                pane: 'pane_Arrondissement_3',
                opacity: 1,
                color: 'rgba(51,160,44,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 3.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(217,126,188,0.0)',
                interactive: true,
            }
        }
        map.createPane('pane_Arrondissement_3');
        map.getPane('pane_Arrondissement_3').style.zIndex = 403;
        map.getPane('pane_Arrondissement_3').style['mix-blend-mode'] = 'normal';
        var layer_Arrondissement_3 = new L.geoJson(json_Arrondissement_3, {
            attribution: '',
            interactive: true,
            dataVar: 'json_Arrondissement_3',
            layerName: 'layer_Arrondissement_3',
            pane: 'pane_Arrondissement_3',
            onEachFeature: pop_Arrondissement_3,
            style: style_Arrondissement_3_0,
        });
        bounds_group.addLayer(layer_Arrondissement_3);
        map.addLayer(layer_Arrondissement_3);
        function pop_Routes_4(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                    if (typeof layer.closePopup == 'function') {
                        layer.closePopup();
                    } else {
                        layer.eachLayer(function(feature){
                            feature.closePopup()
                        });
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['FNODE_'] !== null ? autolinker.link(String(feature.properties['FNODE_']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['TNODE_'] !== null ? autolinker.link(String(feature.properties['TNODE_']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['LPOLY_'] !== null ? autolinker.link(String(feature.properties['LPOLY_']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['RPOLY_'] !== null ? autolinker.link(String(feature.properties['RPOLY_']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['LONGUEUR'] !== null ? autolinker.link(String(feature.properties['LONGUEUR']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['ROUTESA3_'] !== null ? autolinker.link(String(feature.properties['ROUTESA3_']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['ROUTESA3_I'] !== null ? autolinker.link(String(feature.properties['ROUTESA3_I']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['CODE'] !== null ? autolinker.link(String(feature.properties['CODE']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['FONCTION'] !== null ? autolinker.link(String(feature.properties['FONCTION']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_Routes_4_0(feature) {
            switch(String(feature.properties['FONCTION'])) {
                case 'Autres pistes':
                    return {
                pane: 'pane_Routes_4',
                opacity: 1,
                color: 'rgba(222,31,193,1.0)',
                dashArray: '',
                lineCap: 'square',
                lineJoin: 'bevel',
                weight: 1.0,
                fillOpacity: 0,
                interactive: false,
            }
                    break;
                case 'Autres routes':
                    return {
                pane: 'pane_Routes_4',
                opacity: 1,
                color: 'rgba(131,41,200,1.0)',
                dashArray: '',
                lineCap: 'square',
                lineJoin: 'bevel',
                weight: 1.0,
                fillOpacity: 0,
                interactive: false,
            }
                    break;
                case 'Chemin de fer':
                    return {
                pane: 'pane_Routes_4',
                opacity: 1,
                color: 'rgba(0,0,0,1.0)',
                dashArray: '',
                lineCap: 'round',
                lineJoin: 'round',
                weight: 2.0,
                fillOpacity: 0,
                interactive: false,
            }
                    break;
                case 'Digues':
                    return {
                pane: 'pane_Routes_4',
                interactive: false,
            }
                    break;
                case 'Piste automobile':
                    return {
                pane: 'pane_Routes_4',
                opacity: 1,
                color: 'rgba(0,0,0,1.0)',
                dashArray: '',
                lineCap: 'round',
                lineJoin: 'round',
                weight: 3.0,
                fillOpacity: 0,
                interactive: false,
            }
                    break;
                case 'Piste secondaire':
                    return {
                pane: 'pane_Routes_4',
                opacity: 1,
                color: 'rgba(136,230,150,1.0)',
                dashArray: '',
                lineCap: 'square',
                lineJoin: 'bevel',
                weight: 1.0,
                fillOpacity: 0,
                interactive: false,
            }
                    break;
                case 'Route principale':
                    return {
                pane: 'pane_Routes_4',
                opacity: 1,
                color: 'rgba(0,0,0,1.0)',
                dashArray: '',
                lineCap: 'round',
                lineJoin: 'round',
                weight: 2.0,
                fillOpacity: 0,
                interactive: false,
            }
                    break;
                case 'Route principale à 2 voies':
                    return {
                pane: 'pane_Routes_4',
                opacity: 1,
                color: 'rgba(72,123,182,1.0)',
                dashArray: '',
                lineCap: 'square',
                lineJoin: 'bevel',
                weight: 3.0,
                fillOpacity: 0,
                interactive: false,
            }
                    break;
                case 'Route principale à 4 voies':
                    return {
                pane: 'pane_Routes_4',
                opacity: 1,
                color: 'rgba(227,26,28,1.0)',
                dashArray: '',
                lineCap: 'round',
                lineJoin: 'round',
                weight: 5.0,
                fillOpacity: 0,
                interactive: false,
            }
                    break;
            }
        }
        map.createPane('pane_Routes_4');
        map.getPane('pane_Routes_4').style.zIndex = 404;
        map.getPane('pane_Routes_4').style['mix-blend-mode'] = 'normal';
        var layer_Routes_4 = new L.geoJson(json_Routes_4, {
            attribution: '',
            interactive: false,
            dataVar: 'json_Routes_4',
            layerName: 'layer_Routes_4',
            pane: 'pane_Routes_4',
            onEachFeature: pop_Routes_4,
            style: style_Routes_4_0,
        });
        bounds_group.addLayer(layer_Routes_4);
        map.addLayer(layer_Routes_4);
        function pop_localites_5(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                    if (typeof layer.closePopup == 'function') {
                        layer.closePopup();
                    } else {
                        layer.eachLayer(function(feature){
                            feature.closePopup()
                        });
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table>\
                    <tr>\
                        <td colspan="2"><strong>NOM</strong><br />' + (feature.properties['NOM'] !== null ? autolinker.link(String(feature.properties['NOM']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2"><strong>NUM_VILLAG</strong><br />' + (feature.properties['NUM_VILLAG'] !== null ? autolinker.link(String(feature.properties['NUM_VILLAG']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2"><strong>X_UTM</strong><br />' + (feature.properties['X_UTM'] !== null ? autolinker.link(String(feature.properties['X_UTM']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2"><strong>Y_UTM</strong><br />' + (feature.properties['Y_UTM'] !== null ? autolinker.link(String(feature.properties['Y_UTM']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_localites_5_0() {
            return {
                pane: 'pane_localites_5',
                radius: 4.0,
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1,
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(232,113,141,1.0)',
                interactive: true,
            }
        }
        map.createPane('pane_localites_5');
        map.getPane('pane_localites_5').style.zIndex = 405;
        map.getPane('pane_localites_5').style['mix-blend-mode'] = 'normal';
        var layer_localites_5 = new L.geoJson(json_localites_5, {
            attribution: '',
            interactive: true,
            dataVar: 'json_localites_5',
            layerName: 'layer_localites_5',
            pane: 'pane_localites_5',
            onEachFeature: pop_localites_5,
            pointToLayer: function (feature, latlng) {
                var context = {
                    feature: feature,
                    variables: {}
                };
                return L.circleMarker(latlng, style_localites_5_0(feature));
            },
        });
        var cluster_localites_5 = new L.MarkerClusterGroup({showCoverageOnHover: false,
            spiderfyDistanceMultiplier: 2});
        cluster_localites_5.addLayer(layer_localites_5);

        bounds_group.addLayer(layer_localites_5);
        cluster_localites_5.addTo(map);
        const url = {"Nominatim OSM": "https://nominatim.openstreetmap.org/search?format=geojson&addressdetails=1&",
        "France BAN": "https://api-adresse.data.gouv.fr/search/?"}
        var photonControl = L.control.photon({
            url: url["Nominatim OSM"],
            feedbackLabel: '',
            position: 'topleft',
            includePosition: true,
            initial: true,
            // resultsHandler: myHandler,
        }).addTo(map);
        photonControl._container.childNodes[0].style.borderRadius="10px"
        // Create a variable to store the geoJSON data
        var x = null;
        // Create a variable to store the marker
        var marker = null;
        // Add an event listener to the Photon control to create a marker from the returned geoJSON data
        var z = null;
        photonControl.on('selected', function(e) {
            console.log(photonControl.search.resultsContainer);
            if (x != null) {
                map.removeLayer(obj3.marker);
                map.removeLayer(x);
            }
            obj2.gcd = e.choice;
            x = L.geoJSON(obj2.gcd).addTo(map);
            var label = typeof obj2.gcd.properties.label === 'undefined' ? obj2.gcd.properties.display_name : obj2.gcd.properties.label;
            obj3.marker = L.marker(x.getLayers()[0].getLatLng()).bindPopup(label).addTo(map);
            map.setView(x.getLayers()[0].getLatLng(), 17);
            z = typeof e.choice.properties.label === 'undefined'? e.choice.properties.display_name : e.choice.properties.label;
            console.log(e);
            e.target.input.value = z;
        });
        var search = document.getElementsByClassName("leaflet-photon leaflet-control")[0];
        search.classList.add("leaflet-control-search")
        search.style.display = "flex";
        search.style.backgroundColor="rgba(255,255,255,0.5)" 

        // Create the new button element
        var button = document.createElement("div");
        button.id = "gcd-button-control";
        button.className = "gcd-gl-btn fa fa-search search-button";

        // Insert the button at the beginning of the search control
        search.insertBefore(button, search.firstChild);
        last = search.lastChild;
        last.style.display = "none";
        button.addEventListener("click", function (e) {
            if (last.style.display === "none") {
                last.style.display = "block";
            } else {
                last.style.display = "none";
            }
        });
        var baseMaps = {
            "OpenStreetMap": layer_OSM,
            "Google Satellite": layer_GoogleSatellite_0
        };
        var overlaysTree = [
            {label: '<img src="legend/localites_5.png" /> localites', layer: cluster_localites_5},
            {label: 'Routes<br /><table><tr><td style="text-align: center;"><img src="legend/Routes_4_Autrespistes0.png" /></td><td>Autres pistes</td></tr><tr><td style="text-align: center;"><img src="legend/Routes_4_Autresroutes1.png" /></td><td>Autres routes</td></tr><tr><td style="text-align: center;"><img src="legend/Routes_4_Chemindefer2.png" /></td><td>Chemin de fer</td></tr><tr><td style="text-align: center;"><img src="legend/Routes_4_Digues3.png" /></td><td>Digues</td></tr><tr><td style="text-align: center;"><img src="legend/Routes_4_Pisteautomobile4.png" /></td><td>Piste automobile</td></tr><tr><td style="text-align: center;"><img src="legend/Routes_4_Pistesecondaire5.png" /></td><td>Piste secondaire</td></tr><tr><td style="text-align: center;"><img src="legend/Routes_4_Routeprincipale6.png" /></td><td>Route principale</td></tr><tr><td style="text-align: center;"><img src="legend/Routes_4_Routeprincipaleà2voies7.png" /></td><td>Route principale à 2 voies</td></tr><tr><td style="text-align: center;"><img src="legend/Routes_4_Routeprincipaleà4voies8.png" /></td><td>Route principale à 4 voies</td></tr></table>', layer: layer_Routes_4},
            {label: '<img src="legend/Arrondissement_3.png" /> Arrondissement', layer: layer_Arrondissement_3},
            {label: '<img src="legend/Departement_2.png" /> Departement', layer: layer_Departement_2},
            {label: 'Region<br /><table><tr><td style="text-align: center;"><img src="legend/Region_1_DAKAR0.png" /></td><td>DAKAR</td></tr><tr><td style="text-align: center;"><img src="legend/Region_1_DIOURBEL1.png" /></td><td>DIOURBEL</td></tr><tr><td style="text-align: center;"><img src="legend/Region_1_FATICK2.png" /></td><td>FATICK</td></tr><tr><td style="text-align: center;"><img src="legend/Region_1_KAFFRINE3.png" /></td><td>KAFFRINE</td></tr><tr><td style="text-align: center;"><img src="legend/Region_1_KAOLACK4.png" /></td><td>KAOLACK</td></tr><tr><td style="text-align: center;"><img src="legend/Region_1_KEDOUGOU5.png" /></td><td>KEDOUGOU</td></tr><tr><td style="text-align: center;"><img src="legend/Region_1_KOLDA6.png" /></td><td>KOLDA</td></tr><tr><td style="text-align: center;"><img src="legend/Region_1_LOUGA7.png" /></td><td>LOUGA</td></tr><tr><td style="text-align: center;"><img src="legend/Region_1_MATAM8.png" /></td><td>MATAM</td></tr><tr><td style="text-align: center;"><img src="legend/Region_1_SAINTLOUIS9.png" /></td><td>SAINT-LOUIS</td></tr><tr><td style="text-align: center;"><img src="legend/Region_1_SEDHIOU10.png" /></td><td>SEDHIOU</td></tr><tr><td style="text-align: center;"><img src="legend/Region_1_TAMBACOUNDA11.png" /></td><td>TAMBACOUNDA</td></tr><tr><td style="text-align: center;"><img src="legend/Region_1_THIES12.png" /></td><td>THIES</td></tr><tr><td style="text-align: center;"><img src="legend/Region_1_ZIGUINCHOR13.png" /></td><td>ZIGUINCHOR</td></tr></table>', layer: layer_Region_1},]
        var layersControl = L.control.layers.tree(null, overlaysTree,{
            position: 'topleft',
            collapsed: false,
        });
        // Removed addTo(map)

        var basemapControl = L.control.layers(baseMaps, null, {
            position: 'topright',
            collapsed: false
        });
        // Removed addTo(map)

        var legendControl = L.control({position: 'topright'});
        legendControl.onAdd = function(map) {
            var div = L.DomUtil.create('div', 'leaflet-control-legend control-panel');
            div.innerHTML = '<h4>Légende</h4><img src="legend/Region_1.png" /><br>Régions<br><img src="legend/Departement_2.png" /><br>Départements<br><img src="legend/Arrondissement_3.png" /><br>Arrondissements<br><img src="legend/Routes_4.png" /><br>Routes<br><img src="legend/localites_5.png" /><br>Localités';
            return div;
        };
        // Removed addTo(map)
        
        // Toggle panels
        document.getElementById('toggle-layers').addEventListener('click', function() {
            var panel = document.getElementById('layers-panel');
            if (panel) panel.classList.toggle('open');
        });
        document.getElementById('close-layers').addEventListener('click', function() {
            var panel = document.getElementById('layers-panel');
            if (panel) panel.classList.remove('open');
        });
        document.getElementById('toggle-queries').addEventListener('click', function() {
            var panel = document.getElementById('queries-panel');
            if (panel) panel.classList.toggle('open');
        });
        document.getElementById('close-queries').addEventListener('click', function() {
            var panel = document.getElementById('queries-panel');
            if (panel) panel.classList.remove('open');
        });

        
        // Layer controls
        document.getElementById('layer-region').addEventListener('change', function() {
            if (this.checked) {
                map.addLayer(layer_Region_1);
            } else {
                map.removeLayer(layer_Region_1);
            }
        });
        document.getElementById('layer-dept').addEventListener('change', function() {
            if (this.checked) {
                map.addLayer(layer_Departement_2);
            } else {
                map.removeLayer(layer_Departement_2);
            }
        });
        document.getElementById('layer-arr').addEventListener('change', function() {
            if (this.checked) {
                map.addLayer(layer_Arrondissement_3);
            } else {
                map.removeLayer(layer_Arrondissement_3);
            }
        });
        document.getElementById('layer-routes').addEventListener('change', function() {
            if (this.checked) {
                map.addLayer(layer_Routes_4);
            } else {
                map.removeLayer(layer_Routes_4);
            }
        });
        document.getElementById('layer-localites').addEventListener('change', function() {
            if (this.checked) {
                map.addLayer(cluster_localites_5);
            } else {
                map.removeLayer(cluster_localites_5);
            }
        });
        
        // Basemap controls
        document.getElementById('osm').addEventListener('change', function() {
            if (this.checked) {
                map.removeLayer(layer_GoogleSatellite_0);
                map.addLayer(layer_OSM);
            }
        });
        document.getElementById('satellite').addEventListener('change', function() {
            if (this.checked) {
                map.removeLayer(layer_OSM);
                map.addLayer(layer_GoogleSatellite_0);
            }
        });
        function toggleLegend() {
            var content = document.getElementById('legend-content');
            content.style.display = content.style.display === 'none' ? 'block' : 'none';
        }
        miniMap.addTo(map);
        var i = 0;
        layer_Region_1.eachLayer(function(layer) {
            var context = {
                feature: layer.feature,
                variables: {}
            };
            layer.bindTooltip((layer.feature.properties['Région'] !== null?String('<div style="color: #323232; font-size: 10pt; font-family: \'Open Sans\', sans-serif;">' + layer.feature.properties['Région']) + '</div>':''), {permanent: true, offset: [-0, -16], className: 'css_Region_1'});
            labels.push(layer);
            totalMarkers += 1;
              layer.added = true;
              addLabel(layer, i);
              i++;
        });
        resetLabels([layer_Region_1,layer_Departement_2,layer_localites_5]);
        map.on("zoomend", function(){
            resetLabels([layer_Region_1,layer_Departement_2,layer_localites_5]);
        });
        map.on("layeradd", function(){
            resetLabels([layer_Region_1,layer_Departement_2,layer_localites_5]);
        });
        map.on("layerremove", function(){
            resetLabels([layer_Region_1,layer_Departement_2,layer_localites_5]);
        });
        // Navbar actions
        document.getElementById('home').addEventListener('click', function() {
            var welcomePanel = document.getElementById('welcome-panel');
            if (welcomePanel) {
                welcomePanel.style.display = 'block';
            }
            setBounds(); // Go to initial view
        });
        document.getElementById('catalog').addEventListener('click', function() {
            // Afficher le catalogue des données
            var catalogHtml = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 1px solid #ccc; z-index: 2000; max-height: 80vh; overflow-y: auto; width: 80%; max-width: 600px;">
                    <h4>Catalogue des données</h4>
                    <ul>
                        <li><strong>Régions</strong> : Limites administratives des 14 régions du Sénégal (polygones)</li>
                        <li><strong>Départements</strong> : Divisions administratives sous les régions (polygones)</li>
                        <li><strong>Arrondissements</strong> : Sous-divisions des départements (polygones)</li>
                        <li><strong>Routes</strong> : Réseau routier national avec classification (lignes) :
                            <ul>
                                <li>Routes principales</li>
                                <li>Pistes automobiles</li>
                                <li>Voies secondaires</li>
                                <li>Chemins de fer</li>
                            </ul>
                        </li>
                        <li><strong>Localités</strong> : Points d'intérêt urbains et ruraux (points)</li>
                    </ul>
                    <p><strong>Fonds de carte :</strong> OpenStreetMap et Google Satellite</p>
                    <p><strong>Projection :</strong> WGS84 (EPSG:4326) avec coordonnées UTM Zone 28N</p>
                    <button onclick="this.parentElement.style.display='none';" style="margin-top: 10px;">Fermer</button>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', catalogHtml);
        });
        document.getElementById('spatial-query').addEventListener('click', function() {
            document.getElementById('queries-panel').classList.toggle('open');
        });
        document.getElementById('attribute-query').addEventListener('click', function() {
            // Afficher une table attributaire interactive
            var tableHtml = `
                <div id="attribute-modal" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 1px solid #ccc; z-index: 2000; max-height: 80vh; overflow-y: auto; width: 80%; max-width: 600px;">
                    <h4>Table Attributaire - Régions</h4>
                    <table border="1" style="width: 100%;" id="attribute-table">
                        <tr><th>Sélectionner</th><th>Code</th><th>Région</th></tr>
                        <tr><td><input type="checkbox" data-region="DAKAR"></td><td>DKR</td><td>DAKAR</td></tr>
                        <tr><td><input type="checkbox" data-region="DIOURBEL"></td><td>DBL</td><td>DIOURBEL</td></tr>
                        <tr><td><input type="checkbox" data-region="FATICK"></td><td>FAT</td><td>FATICK</td></tr>
                        <tr><td><input type="checkbox" data-region="KAFFRINE"></td><td>KAF</td><td>KAFFRINE</td></tr>
                        <tr><td><input type="checkbox" data-region="KAOLACK"></td><td>KAO</td><td>KAOLACK</td></tr>
                        <tr><td><input type="checkbox" data-region="KEDOUGOU"></td><td>KED</td><td>KEDOUGOU</td></tr>
                        <tr><td><input type="checkbox" data-region="KOLDA"></td><td>KOL</td><td>KOLDA</td></tr>
                        <tr><td><input type="checkbox" data-region="LOUGA"></td><td>LOU</td><td>LOUGA</td></tr>
                        <tr><td><input type="checkbox" data-region="MATAM"></td><td>MAT</td><td>MATAM</td></tr>
                        <tr><td><input type="checkbox" data-region="SAINTLOUIS"></td><td>STL</td><td>SAINT-LOUIS</td></tr>
                        <tr><td><input type="checkbox" data-region="SEDHIOU"></td><td>SED</td><td>SEDHIOU</td></tr>
                        <tr><td><input type="checkbox" data-region="TAMBACOUNDA"></td><td>TAM</td><td>TAMBACOUNDA</td></tr>
                        <tr><td><input type="checkbox" data-region="THIES"></td><td>THI</td><td>THIES</td></tr>
                        <tr><td><input type="checkbox" data-region="ZIGUINCHOR"></td><td>ZIG</td><td>ZIGUINCHOR</td></tr>
                    </table>
                    <div style="margin-top: 10px;">
                        <button id="select-all">Tout sélectionner</button>
                        <button id="deselect-all">Tout désélectionner</button>
                        <button id="zoom-selected">Zoomer sur sélection</button>
                        <button id="highlight-selected">Mettre en évidence</button>
                    </div>
                    <button onclick="document.getElementById('attribute-modal').style.display='none';" style="margin-top: 10px;">Fermer</button>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', tableHtml);
            
            // Event listeners pour les boutons
            document.getElementById('select-all').addEventListener('click', function() {
                var checkboxes = document.querySelectorAll('#attribute-table input[type="checkbox"]');
                checkboxes.forEach(cb => cb.checked = true);
            });
            document.getElementById('deselect-all').addEventListener('click', function() {
                var checkboxes = document.querySelectorAll('#attribute-table input[type="checkbox"]');
                checkboxes.forEach(cb => cb.checked = false);
            });
            document.getElementById('zoom-selected').addEventListener('click', function() {
                var selected = [];
                var checkboxes = document.querySelectorAll('#attribute-table input[type="checkbox"]:checked');
                checkboxes.forEach(cb => selected.push(cb.getAttribute('data-region')));
                if (selected.length > 0) {
                    // Zoomer sur les régions sélectionnées (simplifié)
                    alert('Zoom sur: ' + selected.join(', '));
                } else {
                    alert('Aucune région sélectionnée');
                }
            });
            document.getElementById('highlight-selected').addEventListener('click', function() {
                var selected = [];
                var checkboxes = document.querySelectorAll('#attribute-table input[type="checkbox"]:checked');
                checkboxes.forEach(cb => selected.push(cb.getAttribute('data-region')));
                if (selected.length > 0) {
                    // Mettre en évidence (simplifié)
                    alert('Mise en évidence: ' + selected.join(', '));
                } else {
                    alert('Aucune région sélectionnée');
                }
            });
        });
        document.getElementById('download-csv').addEventListener('click', function() {
            // Simple download links - in real app, would generate from data
            var csvData = 'data:text/csv;charset=utf-8,Région,Code\nDAKAR,DKR\nDIOURBEL,DBL\n'; // Example
            var encodedUri = encodeURI(csvData);
            var link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "senegal_data.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
        document.getElementById('download-geojson').addEventListener('click', function() {
            // Similar for GeoJSON
            alert('Téléchargement GeoJSON - Fonctionnalité en développement');
        });
        document.getElementById('measure').addEventListener('click', function() {
            measureControl._toggleMeasure();
        });
        document.getElementById('zoom-in').addEventListener('click', function() {
            map.zoomIn();
        });
        document.getElementById('zoom-out').addEventListener('click', function() {
            map.zoomOut();
        });

        document.getElementById('print').addEventListener('click', function() {
            window.print();
        });
        document.getElementById('search').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                var query = this.value.toLowerCase();
                // Simple search in regions
                layer_Region_1.eachLayer(function(layer) {
                    var regionName = layer.feature.properties['Région'].toLowerCase();
                    if (regionName.includes(query)) {
                        map.fitBounds(layer.getBounds());
                        layer.openPopup();
                        return false; // Stop after first match
                    }
                });
            }
        });

        document.getElementById('locate-me').addEventListener('click', function() {
            locateControl.start();
        });

        // PWA Installation
        let deferredPrompt;
        const installButton = document.getElementById('install-app');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installButton.style.display = 'block';
        });

        installButton.addEventListener('click', (e) => {
            installButton.style.display = 'none';
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('User accepted the install prompt');
                } else {
                    console.log('User dismissed the install prompt');
                }
                deferredPrompt = null;
            });
        });
        </script>        
        <script>
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('./sw.js').then(registration => {
                        console.log('Service Worker registered with scope:', registration.scope);
                    }).catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
                });
            }
        </script>
    </body>
</html>
